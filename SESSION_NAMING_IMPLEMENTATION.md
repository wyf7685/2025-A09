# 会话名称自动生成功能实现说明

## 功能概述
实现了"自动生成的会话名称为用户第一次提问的内容"功能，替代了原有的基于时间戳的默认命名方式。

## 修改内容

### 1. 后端修改

#### 1.1 会话管理 (`app/api/v1/sessions.py`)
- 在 `get_or_create_session()` 函数中为新会话添加 `name` 字段，初始值为 `None`
- 修改 `get_sessions()` 函数，如果会话名称为空则显示默认格式 `"新会话 {session_id[:8]}"`

#### 1.2 聊天API (`app/api/v1/chat.py`)
- 添加 `clean_message_for_session_name()` 函数，用于清理和格式化用户消息作为会话名称：
  - 移除多余空白字符
  - 过滤特殊字符，保留中英文、数字、常用标点
  - 智能截断过长消息（优先在标点符号处截断）
  - 最大长度限制为30字符
- 修改 `generate_chat_stream()` 函数，在第一条消息时设置会话名称

### 2. 前端修改

#### 2.1 类型定义 (`src/types/session.ts`)
- 为 `Session` 接口添加可选的 `name` 字段及其他会话信息字段

#### 2.2 主应用 (`src/App.vue`)
- 修改会话选择器显示逻辑，优先显示会话名称，否则显示默认格式
- 添加事件监听器，监听会话名称更新事件并重新加载会话列表
- 导入 `onBeforeUnmount` 用于清理事件监听器

#### 2.3 聊天界面 (`src/views/ChatAnalysis.vue`)
- 在发送消息时检测是否为第一条消息
- 在第一条消息完成处理后，触发自定义事件通知父组件重新加载会话列表

### 3. 测试文件 (`test_session_naming.py`)
- 创建了完整的测试套件验证会话命名功能
- 包含消息清理、会话创建、名称更新等多个测试用例
- 提供交互式测试功能

## 功能特点

### 智能命名
- **直接使用用户问题**：会话名称直接使用用户第一次提问的内容
- **自动清理**：移除特殊字符和多余空白
- **智能截断**：优先在标点符号处截断，保持语义完整性
- **长度限制**：最大30字符，防止界面显示问题

### 用户体验
- **实时更新**：第一条消息发送后立即更新会话名称
- **向下兼容**：对于没有名称的旧会话仍显示默认格式
- **可编辑**：用户仍可手动编辑会话名称（如果前端有编辑功能）

### 技术实现
- **事件驱动**：使用自定义事件在前后端间同步状态
- **非阻塞**：会话名称更新不影响正常对话流程
- **容错处理**：处理空消息、特殊字符等边界情况

## 使用示例

### 用户输入 → 会话名称
- `"请帮我分析这个销售数据的趋势"` → `"请帮我分析这个销售数据的趋势"`
- `"如何训练机器学习模型？"` → `"如何训练机器学习模型？"`
- `"这是一个非常非常长的问题内容应该被截断处理..."` → `"这是一个非常非常长的问题内容..."`
- `"包含@#$%特殊字符的消息！"` → `"包含特殊字符的消息"`

## 部署注意事项

1. **数据库迁移**：如果使用数据库存储会话，需要为会话表添加 `name` 字段
2. **缓存清理**：可能需要清理现有会话缓存以确保新字段生效
3. **兼容性**：确保前端能正确处理 `name` 字段为 `null` 的情况

## 测试验证

运行测试文件验证功能：
```bash
python test_session_naming.py
```

测试覆盖：
- ✅ 消息清理和截断
- ✅ 会话创建和名称设置
- ✅ 第一条消息时的名称更新
- ✅ 多会话名称管理
- ✅ API响应格式验证
