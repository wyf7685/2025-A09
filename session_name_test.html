<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>会话名称显示测试</title>
    <style>
      body {
        font-family: 'Arial', sans-serif;
        margin: 0;
        padding: 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      }

      .test-container {
        max-width: 800px;
        margin: 0 auto;
        background: rgba(255, 255, 255, 0.1);
        padding: 30px;
        border-radius: 20px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
      }

      .header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 30px;
        padding: 15px 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      }

      .title {
        font-size: 24px;
        font-weight: 600;
      }

      .current-session {
        padding: 8px 16px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 20px;
        font-size: 14px;
        border: 1px solid rgba(255, 255, 255, 0.3);
        transition: all 0.3s ease;
      }

      .current-session.hidden {
        opacity: 0;
        transform: scale(0.8);
        pointer-events: none;
      }

      .session-label {
        opacity: 0.8;
        margin-right: 6px;
      }

      .session-name {
        font-weight: 600;
      }

      .controls {
        margin: 20px 0;
      }

      .btn {
        padding: 10px 20px;
        background: rgba(255, 255, 255, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.3);
        color: white;
        border-radius: 10px;
        cursor: pointer;
        margin: 0 10px;
        transition: all 0.3s ease;
      }

      .btn:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: translateY(-2px);
      }

      .session-list {
        margin-top: 20px;
      }

      .session-item {
        padding: 12px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        margin: 10px 0;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .session-item:hover {
        background: rgba(255, 255, 255, 0.2);
        transform: translateX(5px);
      }

      .session-item.active {
        background: rgba(255, 255, 255, 0.3);
        border-left: 4px solid #4facfe;
      }

      .test-info {
        background: rgba(255, 255, 255, 0.1);
        padding: 15px;
        border-radius: 10px;
        margin-top: 20px;
        font-size: 14px;
      }
    </style>
  </head>
  <body>
    <div class="test-container">
      <div class="header">
        <div class="title">智能数据分析平台</div>
        <div id="currentSession" class="current-session hidden">
          <span class="session-label">当前对话：</span>
          <span id="sessionName" class="session-name"></span>
        </div>
      </div>

      <div class="controls">
        <button class="btn" onclick="createNewSession()">创建新会话</button>
        <button class="btn" onclick="simulateFirstMessage()">模拟第一条消息</button>
        <button class="btn" onclick="simulateMoreMessages()">模拟更多消息</button>
        <button class="btn" onclick="clearSession()">清空会话</button>
      </div>

      <div class="session-list">
        <h3>会话列表</h3>
        <div id="sessionList"></div>
      </div>

      <div class="test-info">
        <h4>测试说明：</h4>
        <ul>
          <li><strong>初始状态：</strong>不显示当前对话名称</li>
          <li><strong>发送第一条消息后：</strong>显示对话名称，内容为第一次提问</li>
          <li><strong>切换会话：</strong>根据会话是否有消息决定是否显示名称</li>
          <li><strong>会话列表：</strong>区分有消息和无消息的会话显示</li>
        </ul>
      </div>
    </div>

    <script>
      // 模拟会话数据
      let sessions = [];
      let currentSessionId = null;
      let sessionCounter = 0;

      // DOM元素
      const currentSessionEl = document.getElementById('currentSession');
      const sessionNameEl = document.getElementById('sessionName');
      const sessionListEl = document.getElementById('sessionList');

      // 创建新会话
      function createNewSession() {
        const newSession = {
          id: ++sessionCounter,
          name: '',
          messages: [],
          hasMessages: false,
          createdAt: new Date().toISOString(),
        };

        sessions.unshift(newSession);
        currentSessionId = newSession.id;

        // 新会话不显示名称
        hideCurrentSessionName();
        updateSessionList();

        console.log('创建新会话:', newSession);
      }

      // 模拟第一条消息
      function simulateFirstMessage() {
        if (!currentSessionId) {
          alert('请先创建一个会话');
          return;
        }

        const currentSession = sessions.find((s) => s.id === currentSessionId);
        if (!currentSession) return;

        if (currentSession.hasMessages) {
          alert('这个会话已经有消息了');
          return;
        }

        // 模拟用户的第一条消息
        const firstMessage = getRandomFirstMessage();
        currentSession.messages.push({
          type: 'user',
          content: firstMessage,
          timestamp: new Date().toISOString(),
        });

        // 设置会话名称为第一条消息内容
        currentSession.name = firstMessage;
        currentSession.hasMessages = true;

        // 显示当前会话名称
        showCurrentSessionName(firstMessage);
        updateSessionList();

        console.log('发送第一条消息:', firstMessage);
      }

      // 模拟更多消息
      function simulateMoreMessages() {
        if (!currentSessionId) {
          alert('请先创建一个会话');
          return;
        }

        const currentSession = sessions.find((s) => s.id === currentSessionId);
        if (!currentSession || !currentSession.hasMessages) {
          alert('请先发送第一条消息');
          return;
        }

        // 添加更多消息
        const moreMessage = getRandomFollowupMessage();
        currentSession.messages.push({
          type: 'user',
          content: moreMessage,
          timestamp: new Date().toISOString(),
        });

        updateSessionList();
        console.log('发送更多消息:', moreMessage);
      }

      // 清空会话
      function clearSession() {
        if (!currentSessionId) {
          alert('请先选择一个会话');
          return;
        }

        const currentSession = sessions.find((s) => s.id === currentSessionId);
        if (!currentSession) return;

        currentSession.messages = [];
        currentSession.name = '';
        currentSession.hasMessages = false;

        hideCurrentSessionName();
        updateSessionList();

        console.log('清空会话');
      }

      // 切换会话
      function switchToSession(sessionId) {
        currentSessionId = sessionId;
        const session = sessions.find((s) => s.id === sessionId);

        if (session && session.hasMessages && session.name) {
          showCurrentSessionName(session.name);
        } else {
          hideCurrentSessionName();
        }

        updateSessionList();
        console.log('切换到会话:', sessionId);
      }

      // 显示当前会话名称
      function showCurrentSessionName(name) {
        sessionNameEl.textContent = truncateText(name, 25);
        currentSessionEl.classList.remove('hidden');
      }

      // 隐藏当前会话名称
      function hideCurrentSessionName() {
        currentSessionEl.classList.add('hidden');
      }

      // 更新会话列表
      function updateSessionList() {
        sessionListEl.innerHTML = '';

        sessions.forEach((session) => {
          const sessionItem = document.createElement('div');
          sessionItem.className = `session-item ${session.id === currentSessionId ? 'active' : ''}`;

          const displayName =
            session.hasMessages && session.name
              ? truncateText(session.name, 30)
              : `新会话 ${session.id}`;

          const messageCount = session.messages.length;
          const statusText = session.hasMessages ? `${messageCount}条消息` : '未开始';

          sessionItem.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-weight: ${session.hasMessages ? '600' : '400'}; color: ${session.hasMessages ? 'white' : 'rgba(255,255,255,0.7)'}">${displayName}</div>
                            <div style="font-size: 12px; opacity: 0.8;">${statusText}</div>
                        </div>
                        <div style="font-size: 12px; opacity: 0.6;">${formatTime(session.createdAt)}</div>
                    </div>
                `;

          sessionItem.onclick = () => switchToSession(session.id);
          sessionListEl.appendChild(sessionItem);
        });
      }

      // 工具函数
      function truncateText(text, maxLength) {
        return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
      }

      function formatTime(isoString) {
        const date = new Date(isoString);
        return date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
      }

      function getRandomFirstMessage() {
        const messages = [
          '请帮我分析这个销售数据的趋势',
          '如何训练一个机器学习模型？',
          '数据可视化的最佳实践是什么？',
          '我想了解用户行为分析',
          '请解释一下回归分析的原理',
          '如何进行数据清洗和预处理？',
          '能帮我预测下个月的销售额吗？',
          '这个数据集有什么异常值？',
        ];
        return messages[Math.floor(Math.random() * messages.length)];
      }

      function getRandomFollowupMessage() {
        const messages = [
          '能详细解释一下吗？',
          '还有其他方法吗？',
          '这个结果准确吗？',
          '下一步应该怎么做？',
          '有什么注意事项？',
        ];
        return messages[Math.floor(Math.random() * messages.length)];
      }

      // 初始化
      function init() {
        console.log('=== 会话名称显示测试 ===');
        console.log('1. 页面加载时不显示当前对话名称');
        console.log('2. 发送第一条消息后显示对话名称');
        console.log('3. 会话名称为第一次提问的内容');
        console.log('4. 切换会话时根据是否有消息决定显示');

        // 创建一个初始会话用于演示
        createNewSession();
      }

      // 页面加载完成后初始化
      document.addEventListener('DOMContentLoaded', init);
    </script>
  </body>
</html>
